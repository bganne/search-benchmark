/* $Id: anise.c,v 1.9 2012/05/06 22:25:33 alex Exp $ */
/*******************************************************************************

Process:

    anise

    All-iN-I SErver.


Author:    Alex Measday


Purpose:

    Program ANISE is a pocket-sized network server that currently provides
    basic FTP and WWW services to its clients.

    (This program used to be called POSE - POcket SErver - but the name
    conflicts with the Palm OS Emulator - POSE.  So I renamed my program
    to ANISE, an all-in-one server.)


    Invocation (UNIX):

        % anise [-aperror] [-daemon] [-debug] [-log <file>]
                [-target <server>[@<host>]] [-tilde <format>]
                [-ftp <port>] [-pass <port>] [-www <port>]

    Invocation (VxWorks):

        -> sp anise, "[-aperror] [-debug] [-log <file>]
                      [-target <server>[@<host>]] [-tilde <format>]
                      [-ftp <port>] [-pass <port>] [-www <port>]"

    where

        "-aperror"
            turns APERROR() message output on.  APERROR() messages are
            low-level error messages generated by LIBGPL library functions;
            normally, they are disabled.  If enabled, the messages are
            output to STDERR.
        "-daemon"
            causes ANISE to become a daemon process.
        "-debug"
            enables debug output (written to STDOUT).
        "-log <file>"
            enables logging of incoming requests to a file.  This file will
            be used to log all transactions on ports which are specified
            (via the "-ftp" and "-www" options) AFTER the "-log" option.
            If the "-log" option has NOT been specified prior to specifying
            a port, the port's transactions will NOT be logged.  Different
            log files can be used for different ports by simply interspersing
            "-log" options on the command line.
        "-target <server>[@<host>]"
            specifies the target server for subsequent "-pass <port>"s.
        "-tilde <format>"
            specifies a format string used for tilde translation.  The string
            is of the form, "...%s...%s...", where the "%s"s are replaced by
            the user's name and the trailing portion of the resource name,
            respectively.
        "-ftp <port>"
            specifies a network server port (i.e., service name or port
            number) at which ANISE will listen for connection requests
            from FTP clients.  Multiple server ports can be monitored for
            connection requests by repeating this option for each different
            port.
        "-pass <port>"
            specifies a network server port (i.e., service name or port
            number) at which ANISE will listen for connection requests
            from pass-through clients.  Multiple server ports can be
            monitored for connection requests by repeating this option
            for each different port.
        "-www <port>"
            specifies a network server port (i.e., service name or port
            number) at which ANISE will listen for connection requests
            from WWW clients.  Multiple server ports can be monitored for
            connection requests by repeating this option for each different
            port.

*******************************************************************************/


#include  "pragmatics.h"		/* Compiler, OS, logging definitions. */

#include  <stdio.h>			/* Standard I/O definitions. */
#include  <stdlib.h>			/* Standard C library definitions. */
#ifndef _WIN32
#    include  <unistd.h>		/* UNIX-specific definitions. */
#endif
#include  "dae_util.h"			/* Daemon utilities. */
#include  "lfn_util.h"			/* LF-terminated network I/O. */
#include  "log_util.h"			/* Log file utilities. */
#include  "nft_util.h"			/* FTP utilties. */
#include  "iox_util.h"			/* I/O event dispatcher definitions. */
#include  "opt_util.h"			/* Option scanning definitions. */
#include  "port_util.h"			/* Listening port utilities. */
#include  "str_util.h"			/* String manipulation functions. */
#include  "tcp_util.h"			/* TCP/IP networking utilities. */
#include  "ftpClient.h"			/* FTP client utilities. */
#include  "http_util.h"			/* HTTP utilities. */
#include  "passClient.h"		/* Pass-through client utilities. */
#include  "wwwClient.h"			/* WWW client utilities. */
#include  "anise.h"			/* ANISE definitions. */


int  debug = 0 ;			/* Global debug switch (1/0 = yes/no). */

/*******************************************************************************
    The Main Program.
*******************************************************************************/


#ifdef VXWORKS

int  anise (

#    if PROTOTYPES
        char  *commandLine)
#    else
        command_line)

        char  *commandLine ;
#    endif

#else

int  main (

#    if PROTOTYPES
        int  argc,
        char  *argv[])
#    else
        argc, argv)

        int  argc ;
        char  *argv[] ;
#    endif

#endif

{  /* Local variables. */
    bool  isDaemon ;
    char  *argument, *target ;
    int  errflg, option, aperror_save ;
    IoxDispatcher  dispatcher ;
    ListeningPort  port ;
    LogFile  logFile ;
    OptContext  scan ;

    const  char  *optionList[] = {
        "{aperror}", "{daemon}", "{debug}",
        "{ftp:}", "{log:}", "{pass:}",
        "{target:}", "{tilde:}", "{www:}",
        NULL
    } ;




#ifdef VXWORKS
    char  **argv ;
    int  argc ;
		/* Parse command string into an ARGC/ARGV array of arguments. */
    opt_create_argv ("anise", commandLine, &argc, &argv) ;
#endif


    aperror_save = aperror_print ;	/* Save state of APERROR_PRINT flag. */
    aperror_print = 1 ;			/* Enable APERROR output during initialization. */


/* Ignore SIGPIPE signals generated by attempting to write to a broken
   connection. */

#if HAVE_SIGNAL && defined(SIGPIPE)
    signal (SIGPIPE, SIG_IGN) ;
#endif


/*******************************************************************************
  Scan the command line options.
*******************************************************************************/

    if (sktStartup ()) {		/* Initialize networking. */
        exit (errno) ;
    }

    ioxCreate (&dispatcher) ;

    debug = 0 ;  isDaemon = false ;  logFile = NULL ;  target = NULL ;

    opt_init (argc, argv, NULL, optionList, &scan) ;
    errflg = 0 ;

    while ((option = opt_get (scan, &argument))) {

        switch (option) {
        case 1:			/* "-aperror" */
            aperror_save = 1 ;
            break ;
        case 2:			/* "-daemon" */
            isDaemon = true ;
            break ;
        case 3:			/* "-debug" */
            debug = 1 ;
            lfn_util_debug = 1 ;
            nft_util_debug = 1 ;
            iox_util_debug = 1 ;
            port_util_debug = 1 ;
            tcp_util_debug = 1 ;
            aperror_save = 1 ;
            break ;
        case 4:			/* "-ftp <port>" */
            if (portCreate (argument, dispatcher,
                            (ClientCreateFunc) ftpClientCreate,
                            (void *) logFile, &port)) {
                errflg++ ;
            }
            break ;
        case 5:			/* "-log <file>" */
            if (logOpen (argument, "-reopen 10000", &logFile)) {
                LGE "[%s] Error opening log file: %s\nlogOpen: ", argument) ;
                errflg++ ;
            }
            break ;
        case 6:			/* "-pass <port>" */
            if (target == NULL) {
                fprintf (stderr, "[%s] No target specified for pass-through (-pass %s).\n",
                         argv[0], argument) ;
                errflg++ ;
            } else if (portCreate (argument, dispatcher,
                                   (ClientCreateFunc) passClientCreate,
                                   (void *) target, &port)) {
                errflg++ ;
            }
            break ;
        case 7:			/* "-target <server>[@<host>]" */
            target = argument ;
            break ;
        case 8:			/* "-tilde <format>" */
            tildeTranslation = argument ;
            break ;
        case 9:			/* "-www <port>" */
            if (portCreate (argument, dispatcher,
                            (ClientCreateFunc) wwwClientCreate,
                            (void *) logFile, &port)) {
                errflg++ ;
            }
            break ;
        case NONOPT:		/* Ignored. */
            fprintf (stderr, "[%s] Non-option argument ignored: %s\n",
                     argv[0], argument) ;
            break ;
        case OPTERR:
            errflg++ ;  break ;
        default:
            break ;
        }

    }

    opt_term (scan) ;

    if (errflg) {
        fprintf (stderr, "Usage:  anise [-aperror] [-daemon] [-debug] [-log <file>] [-target <server>[@<host>]]\n") ;
        fprintf (stderr, "              [-ftp <port>] [-pass <port>] [-www <port>]\n") ;
        exit (EINVAL) ;
    }

/*******************************************************************************
    If ANISE is to run as a daemon, then make it a daemon.  The daemon's
    working directory is changed from root ("/") back to the original
    working directory in case any files are referenced relative to the
    original directory.
*******************************************************************************/

#if HAVE_WORKING_FORK
    if (isDaemon) {
        char  path[PATH_MAX] ;

        if (getcwd (path, sizeof path) == NULL) {
            LGE "[%s] Error getting current directory.\ngetcwd: ", argv[0]) ;
            exit (errno) ;
        }
        if (daeMonize (3)) {		/* Close stdin, stdout, and stderr. */
            LGE "[%s] Error becoming a daemon.\ndaeMonize: ", argv[0]) ;
            exit (errno) ;
        }
        if (chdir (path)) {
            LGE "[%s] Error returning to daemon's original directory.\nchdir: ",
                argv[0]) ;
            exit (errno) ;
        }
    }
#endif


/*******************************************************************************
    Loop forever, processing input events as they occur.
*******************************************************************************/

    aperror_print = aperror_save ;

    ioxMonitor (dispatcher, -1.0) ;


    exit (0) ;


}
